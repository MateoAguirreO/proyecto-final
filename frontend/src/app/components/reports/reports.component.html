<div class="container">
  <div class="flex-between mb-3">
    <h1>Reportes Genéticos</h1>
    <button class="btn btn-primary" (click)="toggleForm()">
      {{ showForm ? 'Cancelar' : '+ Nuevo Reporte' }}
    </button>
  </div>

  <div *ngIf="showForm" class="card mb-3">
    <h2>Nuevo Reporte de Variante</h2>
    <form (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="patient_id">Paciente</label>
        <select
          id="patient_id"
          [(ngModel)]="selectedPatientId"
          name="patient_id"
          required
        >
          <option value="">Seleccione un paciente...</option>
          <option *ngFor="let patient of patients" [value]="patient._id">
            {{ patient.name }} ({{ patient.gender }})
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="variant">Variante Genética</label>
        <div class="flex gap-2">
          <select
            id="variant"
            [(ngModel)]="reportForm.variant"
            name="variant"
            required
            style="flex: 1"
          >
            <option value="">Seleccione una variante...</option>
            <option *ngFor="let variant of variants" [value]="variant.id">
              {{ variant.gene_info?.symbol || 'N/A' }} - {{ variant.impact }} ({{ variant.chromosome }}:{{ variant.position }})
            </option>
          </select>
          <button type="button" class="btn btn-secondary" (click)="toggleVariantForm()">
            {{ showVariantForm ? 'Cancelar' : '+ Nueva' }}
          </button>
        </div>
      </div>

      <div *ngIf="showVariantForm" class="card mb-3" style="background-color: #f8f9fa; padding: 1rem; margin-top: 0.5rem;">
        <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">Nueva Variante Genética</h3>
        
        <div class="form-group">
          <label for="gene_id">Gen</label>
          <select
            id="gene_id"
            [(ngModel)]="variantForm.gene"
            name="gene_id"
            required
          >
            <option value="">Seleccione un gen...</option>
            <option *ngFor="let gene of genes" [value]="gene.id">
              {{ gene.symbol }} - {{ gene.full_name }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="chromosome">Cromosoma</label>
          <input
            type="text"
            id="chromosome"
            [(ngModel)]="variantForm.chromosome"
            name="chromosome"
            placeholder="ej: chr1, chrX"
            required
          />
        </div>

        <div class="form-group">
          <label for="position">Posición</label>
          <input
            type="number"
            id="position"
            [(ngModel)]="variantForm.position"
            name="position"
            required
          />
        </div>

        <div class="form-group">
          <label for="reference_base">Alelo de Referencia</label>
          <input
            type="text"
            id="reference_base"
            [(ngModel)]="variantForm.reference_base"
            name="reference_base"
            placeholder="ej: A, T, G, C"
            required
          />
        </div>

        <div class="form-group">
          <label for="alternate_base">Alelo Alternativo</label>
          <input
            type="text"
            id="alternate_base"
            [(ngModel)]="variantForm.alternate_base"
            name="alternate_base"
            placeholder="ej: A, T, G, C"
            required
          />
        </div>

        <div class="form-group">
          <label for="impact">Impacto</label>
          <select
            id="impact"
            [(ngModel)]="variantForm.impact"
            name="impact"
            required
          >
            <option value="">Seleccione el impacto...</option>
            <option value="HIGH">Alto</option>
            <option value="MODERATE">Moderado</option>
            <option value="LOW">Bajo</option>
            <option value="MODIFIER">Modificador</option>
          </select>
        </div>

        <div class="form-group">
          <label for="clinical_significance">Significancia Clínica</label>
          <input
            type="text"
            id="clinical_significance"
            [(ngModel)]="variantForm.clinical_significance"
            name="clinical_significance"
            placeholder="ej: Patogénica, Benigna"
          />
        </div>

        <div class="flex gap-2">
          <button type="button" class="btn btn-primary" (click)="createVariant()">Crear Variante</button>
          <button type="button" class="btn btn-secondary" (click)="toggleVariantForm()">Cancelar</button>
        </div>
      </div>

      <div class="form-group">
        <label for="detection_date">Fecha de Detección</label>
        <input
          type="date"
          id="detection_date"
          [(ngModel)]="reportForm.detection_date"
          name="detection_date"
          required
        />
      </div>

      <div class="form-group">
        <label for="allele_frequency">Frecuencia Alélica (0-1)</label>
        <input
          type="number"
          id="allele_frequency"
          [(ngModel)]="reportForm.allele_frequency"
          name="allele_frequency"
          step="0.01"
          min="0"
          max="1"
          required
        />
      </div>

      <div class="form-group">
        <label for="sample_type">Tipo de Muestra</label>
        <input
          type="text"
          id="sample_type"
          [(ngModel)]="reportForm.sample_type"
          name="sample_type"
          placeholder="ej: Sangre, Tejido, Saliva"
        />
      </div>

      <div class="form-group">
        <label for="notes">Notas</label>
        <textarea
          id="notes"
          [(ngModel)]="reportForm.notes"
          name="notes"
        ></textarea>
      </div>

      <div class="flex gap-2">
        <button type="submit" class="btn btn-primary">Crear Reporte</button>
        <button type="button" class="btn btn-secondary" (click)="toggleForm()">Cancelar</button>
      </div>
    </form>
  </div>

  <div *ngIf="loading" class="loading">Cargando reportes...</div>

  <div *ngIf="!loading && reports.length === 0" class="alert alert-info">
    No hay reportes genéticos registrados.
  </div>

  <div *ngIf="!loading && reports.length > 0" class="card">
    <h2>Reportes Registrados</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Paciente</th>
          <th>Variante</th>
          <th>Fecha Detección</th>
          <th>Freq. Alélica</th>
          <th>Tipo Muestra</th>
          <th>Significancia Clínica</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let report of reports">
          <td>{{ getPatientName(report.patient_id) }}</td>
          <td>{{ report.variant_info?.gene_info?.symbol || report.variant }}</td>
          <td>{{ report.detection_date }}</td>
          <td>{{ report.allele_frequency }}</td>
          <td>{{ report.sample_type || 'N/A' }}</td>
          <td>{{ report.variant_info?.clinical_significance || 'N/A' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
